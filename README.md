# practicum_mle_5_uplift

## Работа с виртуальным окружением

### Установки

Обновление локального индекса пакетов
```bash
$ sudo apt-get update
```

Установка расширения для виртуального пространства
```bash
$ sudo apt-get install python3.10-venv
```
### Создание виртуального пространства

```bash
$ python3.10 -m venv .venv_mle_5
```

- python — основа команды.
- 3.10 — версия Python, которую нужно использовать в проекте.
- -m — флаг, сигнализирующий, что нужно запустить внутренний питоновский модуль как скрипт.
- venv — внутренний модуль Python для виртуального пространства.
- .venv_mle_5 — папка внутри проекта, куда нужно сохранить файлы виртуального пространства. Точка делает папку невидимой. Обычно так поступают, чтобы не засорять структуру проекта, но папку можно будет увидеть, если ввести команду ls -la, находясь в папке проекта.

### Работа с виртуальным пространством

Активировать виртуальное пространство
```bash
$ source .venv_mle_5/bin/activate
```

Находясь внутри виртуального пространства, вам нужно будет установить все необходимые библиотеки.
```bash
$ python -m pip install --upgrade pip
$ pip install pandas numpy #  и тд
```
*или (если файл с нужными библиотеками уже подготовлен заранее)*
```bash
$ pip install -r requirements.txt
```

В конце работы для деактивации виртуального пространства достаточно запустить команду
```bash
$ deactivate
```

<br/><br/>

## Сервис

### Запуск сревиса

```bash
$ python -m main.py
```

### Тест сервиса

```bash
$ python -m test_service
```

### Запуск Docker

Соберём его:


```bash
$ docker build -t uplift-model . 
```

Запустим:

```bash
$ docker run --rm -p 5000:5000 --name uplift uplift-model
```

Итак, сервис поднялся. Снова можно протестировать его запросом. Для разнообразия сделаем это с помощью `curl`:

```bash
$ curl -X POST -H "Content-Type: application/json" \
  -d '{"features": [[10, 95.49,  0,  1,  1,  1,  0,  0,  0, 0,  1]]}' \
  http://localhost:5000/predict 
```

```bash
$ curl -X POST -H "Content-Type: application/json" \
  -d '{"features": [[5.0, 98.92, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0], [3.0, 132.65, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0], [9.0, 328.2, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0]]}' \
  http://localhost:5000/predict 
```

Если микросервис успешно возвращает ответ, всё в порядке: Docker-образ рабочий.

### Онлайн-мониторинг качества

Запустим Graphite-сервер для сбора метрик и сам сервис.

Запуск Graphite из готового образа `graphiteapp/graphite-statsd`. Пояснения портов:

- `80`: административный веб-интерфейс,
- `2003/8125`: порты для сбора метрик по разным протоколам (newline delimited, pickle),
- `7002`: порт для получения метрик.

```bash
$ docker run --rm -d \
  --name graphite \
  -p 80:80 \
  -p 2003:2003 \
  -p 8125:8125/udp \
  -p 8126:8126 \
  --name graphite1 \
  graphiteapp/graphite-statsd
```

После запуска Graphite вы можете открыть его веб-интерфейс по адресу `http://<ip address вашей ВМ>:80/`.

Запуск нашего сервиса.

```bash
$ docker build -t uplift-model .
$ docker run --rm -p 5000:5000 --name uplift --link graphite1:graphite uplift-model 
```

Итак, вы собрали и запустили сервис с подсчётом метрик. Теперь, когда входящий запрос обрабатывается в вашем сервисе, все метрики сохраняются в Graphite через `statd`.

Вы можете протестировать сервис, отправив запрос через `curl` или `python`:

```bash
$ curl -X POST -H "Content-Type: application/json" \
  -d '{"features": [[10, 95.49,  0,  1,  1,  1,  0,  0,  0, 0,  1]]}' \
  http://localhost:5000/predict 
```

```bash
$ curl -X POST -H "Content-Type: application/json" \
  -d '{"features": [[5.0, 98.92, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0], [3.0, 132.65, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0], [9.0, 328.2, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0]]}' \
  http://localhost:5000/predict 
```

Затем вы можете проверить, какие метрики записались в Graphite, используя его веб-интерфейс. В иерархии метрик выберите "uplift", чтобы увидеть текущие показания метрик, собранных с сервиса.


